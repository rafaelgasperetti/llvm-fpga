/* Copyright (c) 2009 Ricardo Menotti, All Rights Reserved.
 *
 * Permission to use, copy, modify, and distribute this software and its 
 * documentation for NON-COMERCIAL purposes and without fee is hereby granted 
 * provided that this copyright notice appears in all copies.
 *
 * RICARDO MENOTTI MAKES NO REPRESENTATIONS OR WARRANTIES ABOUT THE SUITABILITY
 * OF THE SOFTWARE, EITHER EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE 
 * IMPLIED WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, OR 
 * NON-INFRINGEMENT. RICARDO MENOTTI SHALL NOT BE LIABLE FOR ANY DAMAGES 
 * SUFFERED BY LICENSEE AS A RESULT OF USING, MODIFYING OR DISTRIBUTING THIS 
 * SOFTWARE OR ITS DERIVATIVES. 
 */

const DATASIZE = 1024;

typedef fixed(32,1) int;
typedef fixed(1,0) bit;

adpcm_decoder(in bit init, out int output, out bit done) {
  
	{
		int indexTable[] = {
			-1, -1, -1, -1, 2, 4, 6, 8,
			-1, -1, -1, -1, 2, 4, 6, 8
		};
		int stepSizeTable[] = {
			7,		8,		9,		10,		11,		12,		13,		14,		16,		17,
			19,		21,		23,		25,		28,		31,		34,		37,		41,		45,
			50,		55,		60,		66,		73,		80,		88,		97,		107,	118,
			130,	143,	157,	173,	190,	209,	230,	253,	279,	307,
			337,	371,	408,	449,	494,	544,	598,	658,	724,	796,
			876,	963,	1060,	1166,	1282,	1411,	1552,	1707,	1878,	2066,
			2272,	2499,	2749,	3024,	3327,	3660,	4026,	4428,	4871,	5358,
			5894,	6484,	7132,	7845,	8630,	9493,	10442,	11487,	12635,	13899,
			15289,	16818,	18500,	20350,	22385,	24623,	27086,	29794,	32767
		};
		int indata[] = {
			7,	17,	27,	37,	47,	57,	67,	77,	87,	97,	107,	117,	0,	10,	20,	30,	40,	50,	60,	70,	80,	90,	100,	110,	120,	3,	13,	23,	33,	43,	53,	63,	73,	83,	93,	103,	113,	123,	6,	16,	26,	36,	46,	56,	66,	76,	86,	96,	106,	116,	126,	9,	19,	29,	39,	49,	59,	69,	79,	89,	99,	109,	119,	2,	12,	22,	32,	42,	52,	62,	72,	82,	92,	102,	112,	122,	5,	15,	25,	35,	45,	55,	65,	75,	85,	95,	105,	115,	125,	8,	18,	28,	38,	48,	58,	68,	78,	88,	98,	108,	118,	1,	11,	21,	31,	41,	51,	61,	71,	81,	91,	101,	111,	121,	4,	14,	24,	34,	44,	54,	64,	74,	84,	94,	104,	114,	124,	7,	
			17,	27,	37,	47,	57,	67,	77,	87,	97,	107,	117,	0,	10,	20,	30,	40,	50,	60,	70,	80,	90,	100,	110,	120,	3,	13,	23,	33,	43,	53,	63,	73,	83,	93,	103,	113,	123,	6,	16,	26,	36,	46,	56,	66,	76,	86,	96,	106,	116,	126,	9,	19,	29,	39,	49,	59,	69,	79,	89,	99,	109,	119,	2,	12,	22,	32,	42,	52,	62,	72,	82,	92,	102,	112,	122,	5,	15,	25,	35,	45,	55,	65,	75,	85,	95,	105,	115,	125,	8,	18,	28,	38,	48,	58,	68,	78,	88,	98,	108,	118,	1,	11,	21,	31,	41,	51,	61,	71,	81,	91,	101,	111,	121,	4,	14,	24,	34,	44,	54,	64,	74,	84,	94,	104,	114,	124,	7,	17,	
			27,	37,	47,	57,	67,	77,	87,	97,	107,	117,	0,	10,	20,	30,	40,	50,	60,	70,	80,	90,	100,	110,	120,	3,	13,	23,	33,	43,	53,	63,	73,	83,	93,	103,	113,	123,	6,	16,	26,	36,	46,	56,	66,	76,	86,	96,	106,	116,	126,	9,	19,	29,	39,	49,	59,	69,	79,	89,	99,	109,	119,	2,	12,	22,	32,	42,	52,	62,	72,	82,	92,	102,	112,	122,	5,	15,	25,	35,	45,	55,	65,	75,	85,	95,	105,	115,	125,	8,	18,	28,	38,	48,	58,	68,	78,	88,	98,	108,	118,	1,	11,	21,	31,	41,	51,	61,	71,	81,	91,	101,	111,	121,	4,	14,	24,	34,	44,	54,	64,	74,	84,	94,	104,	114,	124,	7,	17,	27,	
			37,	47,	57,	67,	77,	87,	97,	107,	117,	0,	10,	20,	30,	40,	50,	60,	70,	80,	90,	100,	110,	120,	3,	13,	23,	33,	43,	53,	63,	73,	83,	93,	103,	113,	123,	6,	16,	26,	36,	46,	56,	66,	76,	86,	96,	106,	116,	126,	9,	19,	29,	39,	49,	59,	69,	79,	89,	99,	109,	119,	2,	12,	22,	32,	42,	52,	62,	72,	82,	92,	102,	112,	122,	5,	15,	25,	35,	45,	55,	65,	75,	85,	95,	105,	115,	125,	8,	18,	28,	38,	48,	58,	68,	78,	88,	98,	108,	118,	1,	11,	21,	31,	41,	51,	61,	71,	81,	91,	101,	111,	121,	4,	14,	24,	34,	44,	54,	64,	74,	84,	94,	104,	114,	124,	7,	17,	27,	37
		}; //512 values
	    int outdata[DATASIZE]; 
	   	fixed(9,0) i;
		fixed(11,0) len;
		int sign;		
		int delta, delta2;		
		int valpred, valpred2, valpred3;	
		int vpdiff, vpdiff2, vpdiff3, vpdiff4;
		int index, index2, index3;		
		int inputbuffer;
		bit bufferstep = 1;
		int step;
	}
	
  	counter (len=0; len<DATASIZE; len++@3);
  	len.clk_en = init;
	indata.address = i;
  	
  	//step@1
	inputbuffer = indata.data_out when !bufferstep & (len.step@1);
	
	//step@2
  	delta = bufferstep ? inputbuffer & 0xf : (inputbuffer >> 4) & 0xf;
	i += 1 when !bufferstep & (len.step@2);

  	//step@3
    sign = delta & 8;
    indexTable.address = delta;
    delta2 = delta & 7;
    bufferstep = !bufferstep;

	//step@4
    index2 = index + indexTable.data_out;	
    stepSizeTable.address = index;
    
	//step@5
    index3 = index2 < 0 ? 0 : index2;
	step = stepSizeTable.data_out;
    
    //step@6   
    index = index3 > 88 ? 88 : index3;
    vpdiff = step >> 3;

    //step@7
    vpdiff2 = ((delta2) & 1) > 0 ? vpdiff + (step >> 2) : vpdiff;

	//step@8
    vpdiff3 = ((delta2) & 2) > 0 ? vpdiff + (step >> 1) : vpdiff2;
	
	//step@9
    vpdiff4 = ((delta2) & 4) > 0 ? vpdiff + (step) : vpdiff3;
    
    //step@10
    valpred2 = (sign) > 0 ? valpred - vpdiff4 : valpred + vpdiff4;
    
    //step@11
	valpred3 = valpred2 > 32767 ? 32767 : valpred2;
    
    //step@12
	valpred = valpred3 < -32768 ? -32768 : valpred3;
    outdata.address = len;

	//step@13
	outdata.data_in = valpred;
	    
    output = outdata.data_out;
    done = len.done;
}
assert{
	
	when output changes
	{
		check int output = {0, 0, 7, 13, 17, 21, 14, 20, 31, 39, 25, 42, 33, 58, 75, 103, 69, 119, 193, 353, 447, 705, 450, 867, 1762, 1907, 2039, 2159, 1612, 1910, 2724, 3052, 2157, 3038, 2878, 3606, 4268, 4869, 3884, 5076, 6518, 9074, 9489, 12891, 10124, 14653, 22676, 32384, 15184, 32767, 28672, 32396, 32767, 32767, 7584, 19870, 32767, 32767, 32767, 32767, 17379, 31369, 32767, 32767, 2296, 32767, 20481, 32767, 32767, 32767, -4095, 32767, 32767, 32767, 32767, 32767, 12289, 16013, 32767, 32767, 32767, 32767, 17379, 31369, 32767, 32767, 7584, 28062, 24338, 32767, 32767, 32767, -4095, 32767, 32767, 32767, 32767, 32767, 12289, 32767, 32767, 32767, -4095, 0, -11172, -1016, 14372, 22766, -127, 18494, 32767, 32767, 32767, 32767, 17379, 32767, 32767, 32767, -4095, 32767, 20481, 32767, 32767, 32767, -4095, 32767, 32767, 32767, 32767, 32767, 5067, 16239, 32767, 32767, 32767, 32767, 17379, 31369, 32767, 32767, 7584, 32767, 28672, 32767, 32767, 32767, -4095, 32767, 32767, 32767, 32767, 32767, 12289, 16013, 32767, 32767, -751, 11535, 363, 17291, 32679, 32767, 9874, 28495, 32767, 32767, 32767, 32767, 12289, 32767, 32767, 32767, -4095, 32767, 20481, 32767, 32767, 32767, -4095, 0, -3724, 6432, 21820, 30214, 7321, 22709, 32767, 32767, 32767, 32767, 17379, 32767, 32767, 32767, -4095, 32767, 28672, 32767, 32767, 32767, -4095, 32767, 32767, 32767, 32767, 32767, 17379, 25773, 32767, 32767, 2296, 22774, 11602, 28530, 32767, 32767, 9874, 32767, 32767, 32767, 32767, 32767, 12289, 32767, 32767, 32767, -4095, 32767, 20481, 24205, 32767, 32767, -751, 11535, 7811, 24739, 32767, 32767, 9874, 25262, 32767, 32767, 32767, 32767, 12289, 32767, 32767, 32767, -4095, 32767, 28672, 32767, 32767, 32767, -4095, 0, 32767, 32767, 32767, 32767, 17379, 31369, 32767, 32767, 2296, 22774, 11602, 32767, 32767, 32767, -4095, 32767, 32767, 32767, 32767, 32767, 12289, 32767, 32767, 32767, 32767, 32767, 17379, 25773, 32767, 32767, 7584, 28062, 24338, 32767, 32767, 32767, 9874, 32767, 32767, 32767, 32767, 32767, 12289, 32767, 32767, 32767, -4095, 32767, 28672, 32396, 32767, 32767, 7584, 19870, 32767, 32767, 32767, 32767, 17379, 31369, 32767, 32767, 2296, 32767, 20481, 32767, 32767, 32767, -4095, 32767, 32767, 32767, 32767, 32767, 12289, 16013, 32767, 32767, 32767, 32767, 17379, 31369, 32767, 32767, 7584, 28062, 24338, 32767, 32767, 32767, -4095, 32767, 32767, 32767, 32767, 32767, 12289, 32767, 32767, 32767, -4095, 0, -11172, -1016, 14372, 22766, -127, 18494, 32767, 32767, 32767, 32767, 17379, 32767, 32767, 32767, -4095, 32767, 20481, 32767, 32767, 32767, -4095, 32767, 32767, 32767, 32767, 32767, 5067, 16239, 32767, 32767, 32767, 32767, 17379, 31369, 32767, 32767, 7584, 32767, 28672, 32767, 32767, 32767, -4095, 32767, 32767, 32767, 32767, 32767, 12289, 16013, 32767, 32767, -751, 11535, 363, 17291, 32679, 32767, 9874, 28495, 32767, 32767, 32767, 32767, 12289, 32767, 32767, 32767, -4095, 32767, 20481, 32767, 32767, 32767, -4095, 0, -3724, 6432, 21820, 30214, 7321, 22709, 32767, 32767, 32767, 32767, 17379, 32767, 32767, 32767, -4095, 32767, 28672, 32767, 32767, 32767, -4095, 32767, 32767, 32767, 32767, 32767, 17379, 25773, 32767, 32767, 2296, 22774, 11602, 28530, 32767, 32767, 9874, 32767, 32767, 32767, 32767, 32767, 12289, 32767, 32767, 32767, -4095, 32767, 20481, 24205, 32767, 32767, -751, 11535, 7811, 24739, 32767, 32767, 9874, 25262, 32767, 32767, 32767, 32767, 12289, 32767, 32767, 32767, -4095, 32767, 28672, 32767, 32767, 32767, -4095, 0, 32767, 32767, 32767, 32767, 17379, 31369, 32767, 32767, 2296, 22774, 11602, 32767, 32767, 32767, -4095, 32767, 32767, 32767, 32767, 32767, 12289, 32767, 32767, 32767, 32767, 32767, 17379, 25773, 32767, 32767, 7584, 28062, 24338, 32767, 32767, 32767, 9874, 32767, 32767, 32767, 32767, 32767, 12289, 32767, 32767, 32767, -4095, 32767, 28672, 32396, 32767, 32767, 7584, 19870, 32767, 32767, 32767, 32767, 17379, 31369, 32767, 32767, 2296, 32767, 20481, 32767, 32767, 32767, -4095, 32767, 32767, 32767, 32767, 32767, 12289, 16013, 32767, 32767, 32767, 32767, 17379, 31369, 32767, 32767, 7584, 28062, 24338, 32767, 32767, 32767, -4095, 32767, 32767, 32767, 32767, 32767, 12289, 32767, 32767, 32767, -4095, 0, -11172, -1016, 14372, 22766, -127, 18494, 32767, 32767, 32767, 32767, 17379, 32767, 32767, 32767, -4095, 32767, 20481, 32767, 32767, 32767, -4095, 32767, 32767, 32767, 32767, 32767, 5067, 16239, 32767, 32767, 32767, 32767, 17379, 31369, 32767, 32767, 7584, 32767, 28672, 32767, 32767, 32767, -4095, 32767, 32767, 32767, 32767, 32767, 12289, 16013, 32767, 32767, -751, 11535, 363, 17291, 32679, 32767, 9874, 28495, 32767, 32767, 32767, 32767, 12289, 32767, 32767, 32767, -4095, 32767, 20481, 32767, 32767, 32767, -4095, 0, -3724, 6432, 21820, 30214, 7321, 22709, 32767, 32767, 32767, 32767, 17379, 32767, 32767, 32767, -4095, 32767, 28672, 32767, 32767, 32767, -4095, 32767, 32767, 32767, 32767, 32767, 17379, 25773, 32767, 32767, 2296, 22774, 11602, 28530, 32767, 32767, 9874, 32767, 32767, 32767, 32767, 32767, 12289, 32767, 32767, 32767, -4095, 32767, 20481, 24205, 32767, 32767, -751, 11535, 7811, 24739, 32767, 32767, 9874, 25262, 32767, 32767, 32767, 32767, 12289, 32767, 32767, 32767, -4095, 32767, 28672, 32767, 32767, 32767, -4095, 0, 32767, 32767, 32767, 32767, 17379, 31369, 32767, 32767, 2296, 22774, 11602, 32767, 32767, 32767, -4095, 32767, 32767, 32767, 32767, 32767, 12289, 32767, 32767, 32767, 32767, 32767, 17379, 25773, 32767, 32767, 7584, 28062, 24338, 32767, 32767, 32767, 9874, 32767, 32767, 32767, 32767, 32767, 12289, 32767, 32767, 32767, -4095, 32767, 28672, 32396, 32767, 32767, 7584, 19870, 32767, 32767, 32767, 32767, 17379, 31369, 32767, 32767, 2296, 32767, 20481, 32767, 32767, 32767, -4095, 32767, 32767, 32767, 32767, 32767, 12289, 16013, 32767, 32767, 32767, 32767, 17379, 31369, 32767, 32767, 7584, 28062, 24338, 32767, 32767, 32767, -4095, 32767, 32767, 32767, 32767, 32767, 12289, 32767, 32767, 32767, -4095, 0, -11172, -1016, 14372, 22766, -127, 18494, 32767, 32767, 32767, 32767, 17379, 32767, 32767, 32767, -4095, 32767, 20481, 32767, 32767, 32767, -4095, 32767, 32767, 32767, 32767, 32767, 5067, 16239, 32767, 32767, 32767, 32767, 17379, 31369, 32767, 32767, 7584, 32767, 28672, 32767, 32767, 32767, -4095, 32767, 32767, 32767, 32767, 32767, 12289, 16013, 32767, 32767, -751, 11535, 363, 17291, 32679, 32767, 9874, 28495, 32767, 32767, 32767, 32767, 12289, 32767, 32767, 32767, -4095, 32767, 20481, 32767, 32767, 32767, -4095, 0, -3724, 6432, 21820, 30214, 7321, 22709, 32767, 32767, 32767, 32767, 17379, 32767, 32767, 32767, -4095, 32767, 28672, 32767, 32767, 32767, -4095, 32767, 32767, 32767, 32767, 32767, 17379, 25773, 32767, 32767, 2296, 22774, 11602, 28530, 32767, 32767, 9874, 32767, 32767, 32767, 32767, 32767, 12289, 32767, 32767, 32767, -4095, 32767, 20481, 24205, 32767, 32767, -751, 11535, 7811, 24739, 32767, 32767, 9874, 25262, 32767, 32767, 32767, 32767, 12289, 32767, 32767, 32767, -4095, 32767, 28672, 32767, 32767, 32767, -4095, 0, 32767, 32767, 32767, 32767, 17379, 31369};
	}
}
